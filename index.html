<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SeBa online</title>
  <script src='https://cdn.plot.ly/plotly-3.3.0.min.js'></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }

    label {
      display: inline-block;
    }

    #log {
      font-family: monospace;
      white-space: pre-wrap;
      border: 1px solid #ccc;
      padding: 8px;
      overflow-y: auto;
      line-height: 1.2em;
      min-height: calc(1.2em * 20); /* approx. 20 lines visible */
      max-height: 400px;
      background: #f9f9f9;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      max-width: 600px;
    }
    .tooltip {
	position: relative;
	display: inline-block;
    }
    .tooltiptext {
	visibility: hidden; /* Hidden by default */
	width: 130px;
	background-color: black;
	color: #ffffff;
	text-align: center;
	padding: 5px 0;
	border-radius: 6px;
	position: absolute;
	z-index: 1; /* Ensure tooltip is displayed above content */
    }
    
    /* Show the tooltip text on hover */
    .tooltip:hover .tooltiptext {
	visibility: visible;
    }
    
    th, td {
      border: 1px solid #ccc;
      padding: 4px 8px;
      text-align: left;
      font-family: monospace;
    }

    th {
      background: #eee;
    }

    #run-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    #status {
      margin-left: 10px;
      font-size: 0.9em;
      color: #555;
    }
    p.hide-close {
	font-size: larger;
    }
  </style>
</head>
<body>
  <h1 data-i8n="seba-main-title">SeBa online</h1>
  <nav>
    <button id="lang-toggle" data-i8n="switch-lang" onclick="switchLang('nl');">Switch to Dutch</button>
  </nav>

  <section id="controls">
    WebAssembly Runner
    <form id="user-input">
      <template id="control-template">
	<div id="template-slider">
	  <input type="range" id="template-range" step="0.01" data-input="template-input" oninput="updateFromSlider(this)">
	  <input type="number" id="template-input" min="0.01" max="100" value="1" step="any" data-range="template-range" onblur="clampValue(this);" oninput="updateFromInput(this);">
	  <div class="tooltip" id="template-tooltip">â“˜ <span class="tooltiptext" data-i8n="template-tooltip">something here</span></div>
	  <p><label for="template-input" data-i8n="template-label"><span data-i8n="template-name"></spam>(<span id="template-min-value"></span> &ndash; <span id="template-max-value"></span>)</label></p>
	</div>
      </template>
    </form>

<!--
      <div>
	<label for="m1">Massa eerste ster</label>
	<input id="m1" type="text" value="2">
      </div>
  <div>
    <label for="m2">Massa tweede ster</label>
    <input id="m2" type="text" value="1">
  </div>
  <div>
    <label for="e">Eccentriciteit</label>
    <input id="e" type="text" value="0.2">
  </div>
  <div>
    <label for="a">Baanscheiding</label>
    <input id="a" type="text" value="200">
    <p>Afstand tussen sterren in eenheden van zonneradius</p>
  </div>
  <div>
    <label for="T">Tijd</label>
    <input id="T" type="text" value="13500">
    <p>Tijd in miljoenen jaren (megajaar)</p>
  </div>
  <div>
    <label for="z">Metalliciteit</label>
    <input id="z" type="text" value="0.001">
    <p>Metaalgehalte van de sterren</p>
  </div>
-->
  <div style="margin-top: 10px;">
    <button id="run-button" disabled>Run</button>
    <span id="status"></span>
  </div>

  <section id="program-section">
    <details>
      <summary data-i8n="program-log">Program log</summary>
      <output id="program-log"></output>
    </details>
  </section>

  <section id="graph"></section>

  <section id="data-section">
    <h2>Output data</h2>
    <table id="data-table">
      <thead>
        <tr>
        </tr>
      </thead>
      <tbody>
        <!-- Rows will be inserted here -->
      </tbody>
    </table>
  </div>

  <!--
    Define Module BEFORE loading SeBa.js so Emscripten uses these hooks.
    SeBa.js must be in the same directory as this HTML.
  -->
  <script>
    function $id(idspec) {
	return document.getElementById(idspec);
    }

    function $q(selector) {
	return document.querySelector(selector);
    }

    function $qa(selector) {
        return document.querySelectorAll(selector);
    }
    
    function $create(element) {
	return document.createElement(element);
    }

    const COLS = ['binid', 'bintype', 'transfertype', 'time',
		   'sep', 'ecc', 'id1', 'type1', 'mass1',
		   'radius1', 'efftemp1', 'coremass1',
		   'id2', 'type2', 'mass2',
		  'radius2', 'efftemp2', 'coremass2'];
    const NAMES = {
	binid: 'binary identity number',
	bintype: 'binary type',
	transfertype: 'mass transfer type',
	time: 'time',
	sep: 'separation in Solar radii',
	ecc: 'eccentricity',
	id1: 'stellar identity number 1',
	type1: 'star type 1',
	mass1: 'stellar mass in Solar mass 1',
	radius1: 'stellar radius in Solar radii 1',
	efftemp1: 'log of effective temperature 1',
	coremass1: 'core mass in Solar mass 1',
	id2: 'stellar identity number 2',
	type2: 'star type 2',
	mass2: 'stellar mass in Solar mass 2',
	radius2: 'stellar radius in Solar radii 2',
	efftemp2: 'log of effective temperature 2',
	coremass2: 'core mass in Solar mass 2'
    };
    const stdoutElem = $id('log');
    const tableBody = $q('#data-table tbody');
    const runButton = $id('run-button');
    const statusElem = $id('status');

    // Collect output lines in memory as well
    const stdoutLines = [];
    const stderrLines = [];
    const CONTROLS = [
	{name: "mass1", min: 0.01, max: 100, value: 1, step: 0.01, log: true},
	{name: "mass2", min: 0.01, max: 100, value: 1, step: 0.01, log: true},
	{name: "ecc", min: 1e-5, max: 0.999, value: 0.2, step: 0.01, log: true},
	{name: "sep", min: 1, max: 1e4, value: 200, step: 0.01, log: true},
	{name: "time", min: 1, max: 1e7, value: 13500, step: 0.01, log: true},
	{name: "metal", min: 1e-5, max: 1e-1, value: 1e-3, step: 0.01, log: true}
    ];

    // Supported languages with a translation file
    const LANGUAGES = ["en", "nl"];
    
    var Module;  // global variable for the WASM module
    var translations = {};

    function createTableHeader() {
	row = $q('#data-table thead tr');
	for (const col of COLS) {
	    const th = $create('th');
	    th.textContent = NAMES[col];
	    row.appendChild(th);
	}
    }


    // Helper to append a line to the stdout display
    function appendOutput(text, isError) {
      // const prefix = isError ? '[stderr] ' : '';
      // const line = prefix + text;
      stdoutLines.push(text);
      stdoutElem.textContent = stdoutLines.join('\n');
      // Scroll to bottom
      stdoutElem.scrollTop = stdoutElem.scrollHeight;
    }

    function setupModule() {
	// Emscripten Module configuration object
	Module = {
	    print: function(text) {          // stdout
		appendOutput(text, false);
	    },
	    printErr: function(text) {       // stderr
		appendOutput(text, true);
	    },
	    onRuntimeInitialized: function() {
		// Enable the Run button once WASM is ready
		/*statusElem.textContent = 'Ready.';*/
		$id('run-button').disabled = false;
	    }
	};
    }

    function createControls() {
	const template = $q("#control-template");
	for (const control of CONTROLS) {
	    const clone = document.importNode(template.content, true);
	    const name = control["name"];

	    let div = clone.querySelector("div");
	    div.id = `${name}-control`;
	    let tooltip = div.querySelector("div");
	    tooltip.id = `${name}-tooltip`;
	    let tooltiptext = tooltip.querySelector("span");
	    tooltiptext.dataset.i8n = `${name}-tooltip`;
	   
	    let label = clone.querySelector("label");
	    label.name = name;
	    label.htmlFor = `${name}-input`;
	    label.dataset.i8n = `${name}-label`;
	    label.innerHTML = `<span data-i8n="${name}-name"></span> (<span id="${name}-min-value"></span> &ndash; <span id="${name}-max-value"></span>)</label>`;
	    let input = clone.querySelector("input[type=number]");
	    input.id = `${name}-input`;
	    input.min = control["min"];
	    input.max = control["max"];
	    input.value = control["value"];
	    input.dataset.range = name;

	    let slider = clone.querySelector("input[type=range]");
	    slider.id = `${name}-range`;
	    slider.min = Math.log10(control["min"]);
	    slider.max = Math.log10(control["max"]);
	    slider.step = control["step"];
	    slider.value = Math.log10(control["value"]);
	    slider.dataset.input = name;

	    const form = $q("#controls form");
	    form.appendChild(clone);
	}
    }

    function updateMinMax() {
	for (const label of $qa("form#user-input label")) {
	    const name = label.name;
	    let values = [];
	    for (const control of CONTROLS) {
		if (control["name"] == name) {
		    values = {"min": control["min"], "max": control["max"]};
		    break;
		}
	    }
	    if (!values) {
		console.warn("Missing min-max values for ", name);
		return ;
	    }
	    let minval = label.querySelector(`#${name}-min-value`);
	    minval.textContent = values["min"];
	    let maxval = label.querySelector(`#${name}-max-value`);
	    maxval.textContent = values["max"];
	}

    }
	
    async function loadTranslations() {
	for (lang of LANGUAGES) {
	    try {
		const response = await fetch(`${lang}.json`);
		
		if (!response.ok) {
		    throw new Error(`Could not fetch ${lang}.json`);
		}
		
		translations[lang] = await response.json();
		
	    } catch (error) {
		console.error("Translation error:", error);
	    }
	}
    }

    function switchLang(lang) {
	//let lang = document.documentElement.lang;
	document.documentElement.lang = lang;
	if (!lang in translations) {
	    lang = "en";  // fallback value
	}
	const translation = translations[lang];
	const elements = document.querySelectorAll("[data-i8n]");
	for (const element of elements) {
	    const key = element.dataset.i8n;
	    if (key in translation) {
		value = translation[key];
		element.textContent = value;
	    }
	}

    }
	
    
    function updateFromSlider(slider) {
	const id = `${slider.dataset.input}-input`;
	let input = $id(id);
	const actualValue = Math.pow(10, parseFloat(slider.value));
	input.value = Math.round(actualValue * 100) / 100; // Keep 2 decimals
  }

  // Convert actual value back to slider position (log10)
  function updateFromInput(input) {
      const id = `${input.dataset.range}-range`;
      const slider = $id(id);
      const min = parseFloat(input.min);
      const max = parseFloat(input.max);
      value = parseFloat(input.value);
      if (isNaN(value)) {
	  return ;
      }

      if (value < min) {
	  value = min;
      } else if (value > max) {
	  value = max;
      }
      if (value > 0) {
	slider.value = Math.log10(value);
    }
  }

      function clampValue(input) {
	  const min = parseFloat(input.min);
	  const max = parseFloat(input.max);
	  let value = parseFloat(input.value);

	  if (isNaN(value)) {
	      input.value = min; // Default to min if input is empty/invalid
	      updateFromInput(input);
	      return;
	  }

	  if (value < min) {
	      input.value = min;
	  } else if (value > max) {
	      input.value = max;
	  }
      }

    // Run button handler
    function run() {
      if (!Module || !Module.callMain) {
        alert('Module not initialized yet.');
        return;
      }

      // Clear previous output
      stdoutLines.length = 0;
      stdoutElem.textContent = '';
      tableBody.innerHTML = '';
      /*statusElem.textContent = 'Running...';*/
      $id('run-button').disabled = true;

	const args = [
	    '-M',
	    document.getElementById('m1').value.trim(),
	    '-m',
	    document.getElementById('m2').value.trim(),
	    '-e',
	    document.getElementById('e').value.trim(),
	    '-a',
	    document.getElementById('a').value.trim(),
	    '-T',
	    document.getElementById('T').value.trim(),
	    '-z',
	    document.getElementById('z').value.trim()
	];


      // Optional: remove previous SeBa.data if it exists
      try {
        Module.FS.unlink('SeBa.data');
      } catch (e) {
        // Ignore if file did not exist
      }

      // Call main(argc, argv) via callMain
      try {
        Module.callMain(args);
      } catch (e) {
        appendOutput('Exception: ' + e, true);
      }

      // After main returns, try to read output.txt
      try {
          const text = Module.FS.readFile('SeBa.data', { encoding: 'utf8' });
	  data = readData(text);
          /*populateTableFromOutput(text);*/
	  populateTable(data);
	  plotResults(data);
      } catch (e) {
        appendOutput('Could not read SeBa.data: ' + e, true);
      }

      $id('run-button').disabled = false;
    };

    $id('run-button').addEventListener('click', run)


    function readData(fileContent) {
	var array = Array.from({length: 18}, _ => []);
	const lines = fileContent.split(/\r?\n/);
	for (const line of lines) {
	    const trimmed = line.trim();
	    if (!trimmed) {
		continue;
	    }
	    const cols = trimmed.split(/\s+/);
	    for (const i in cols) {
		array[i].push(parseFloat(cols[i]));
	    }
	}

	var data = {};
	COLS.forEach((name, index) => {
	    data[name] = array[index];
	});
	return data;
    }

    function populateTable(data) {
	const tbody = $q('#data-table tbody');
	for (var rownr = 0; rownr < data[COLS[0]].length; ++rownr) {
	    const tr = $create('tr');
	    for (const col of COLS) {
		const td = $create('td');
		td.textContent = data[col][rownr];
		tr.appendChild(td);
	    }
	    tbody.appendChild(tr);
	}
    }

    // Parse output.txt lines, extract columns 1, 2, and 5 into the table
    function populateTableFromOutput(fileContent) {
      const lines = fileContent.split(/\r?\n/);

      for (const line of lines) {
        const trimmed = line.trim();
        if (!trimmed) continue;                 // skip empty lines
        if (trimmed.startsWith('#')) continue;  // skip comment lines (optional)

        // Split on whitespace (spaces/tabs)
        const cols = trimmed.split(/\s+/);
        if (cols.length < 5) continue;          // need at least 5 columns


        const c1 = cols[4];
        const c2 = cols[9];

        const tr = $create('tr');

        const td1 = $create('td');
        td1.textContent = c1;
        tr.appendChild(td1);

        const td2 = $create('td');
        td2.textContent = c2;
        tr.appendChild(td2);

        tableBody.appendChild(tr);
      }
    }

    function plotResults(data) {
	var trace1 = {
	    x: [0, 1, 2, 3, 4, 5, 6, 7, 8],
	    y: [8, 7, 6, 5, 4, 3, 2, 1, 0],
	    type: 'scatter'
	};

	var trace2 = {
	    x: [0, 1, 2, 3, 4, 5, 6, 7, 8],
	    y: [0, 1, 2, 3, 4, 5, 6, 7, 8],
	    type: 'scatter'
	};

	var plottingData = {
	    x: data[3],
	    y: data[9],
	    type: 'scatter'
	};

	var layout = {
	    xaxis: {
		type: 'log',
		autorange: true
	    },
	    yaxis: {
		//type: 'log',
		autorange: true
	    }
	};
	console.log(plottingData);
	Plotly.newPlot('graph', [plottingData], layout);
    }


    function init() {
	loadTranslations().then(() => {
	    console.log(Object.keys(translations));
	    console.log(translations["nl"]);
	    console.log(translations["nl"]["ecc-name"]);
	    switchLang("en");
	    updateMinMax();

	});
	createControls();
	createTableHeader();
	setupModule();
    }

    init();

    
  </script>
    <!-- Load the generated JS glue code (SeBa.js) after the setup -->
  <script src="SeBa.js"></script>
  
</body>
</html>
